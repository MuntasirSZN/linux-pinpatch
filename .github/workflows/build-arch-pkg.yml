name: Build Arch PKGBUILD
on:
  workflow_dispatch:
  push:
    branches: [main, master]
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Prepare system and build PKGBUILD
        run: |
          set -e
          # Determine repo path early so we can install makedepends as root
          REPO="${GITHUB_WORKSPACE:-}"
          if [ -z "$REPO" ]; then
            if [ -d /github/workspace ]; then
              REPO=/github/workspace
            elif [ -d /github/home ]; then
              REPO=/github/home
            elif [ -d /__w ]; then
              REPO=/__w
            else
              REPO="$PWD"
            fi
          fi
          echo "Detected repo: $REPO"

          # Refresh keyring and init pacman keys
          pacman -Sy --noconfirm archlinux-keyring
          pacman-key --init
          pacman-key --populate archlinux
          # Install base build deps (as root)
          pacman -Syu --noconfirm --needed base-devel fakeroot git devtools

          # If PKGBUILD exists, try to extract makedepends and install them as root
          if [ -f "$REPO/PKGBUILD" ]; then
            echo "Installing makedepends from PKGBUILD..."
            deps=$(awk '/^makedepends=\(/ {p=1; next} p && /^\)/ {p=0; exit} p {gsub(/^[ \t]+|[ \t]+$/,"",$0); if($0!~/^#/){print}}' "$REPO/PKGBUILD" | tr '\n' ' ')
            # remove comments and empty entries
            deps=$(echo "$deps" | sed 's/#.*//g' | xargs)
            if [ -n "$deps" ]; then
              echo "Installing: $deps"
              pacman -S --noconfirm --needed $deps || true
            else
              echo "No makedepends found or failed to parse; skipping."
            fi
          else
            echo "No PKGBUILD at $REPO/PKGBUILD; skipping makedepends install"
          fi

          # Create a non-root user for makepkg
          useradd -m builder

          # Determine workspace path used inside the container and chown
          WORKDIR="${GITHUB_WORKSPACE:-}"
          if [ -n "$WORKDIR" ] && [ -d "$WORKDIR" ]; then
            chown -R builder:builder "$WORKDIR"
          elif [ -d /github/workspace ]; then
            chown -R builder:builder /github/workspace
            WORKDIR=/github/workspace
          elif [ -d /github/home ]; then
            chown -R builder:builder /github/home
            WORKDIR=/github/home
          elif [ -n "$PWD" ] && [ -d "$PWD" ]; then
            chown -R builder:builder "$PWD"
            WORKDIR="$PWD"
          elif [ -d /__w ]; then
            chown -R builder:builder /__w
            WORKDIR=/__w
          else
            echo "Workspace not found; listing /github and /__w:"
            ls -la /github || true
            ls -la /__w || true
            exit 1
          fi

          # Get keys
          su builder -c "gpg --keyserver hkps://keyserver.ubuntu.com --recv-keys 38DBBDC86092693E B8AC08600F108CDF"

          # Build the package (as non-root)
          su builder -c "cd \"$WORKDIR\" && MAKEFLAGS=\"--jobs=$(nproc)\" makepkg -s --noconfirm --noprogressbar"
        shell: bash
      - name: List workspace files
        run: |
          TARGETS=("${GITHUB_WORKSPACE:-}" /github/workspace /github/home "$PWD" /__w)
          for t in "${TARGETS[@]}"; do
            if [ -n "$t" ] && [ -d "$t" ]; then
              echo "Listing: $t"
              ls -la "$t" || true
              break
            fi
          done
        shell: bash
      - name: Upload whole workspace
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: workspace
          path: |
            ${{ env.GITHUB_WORKSPACE }}
            /github/workspace
            /github/home
            ${{ github.workspace }}
            /__w
